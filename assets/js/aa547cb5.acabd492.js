"use strict";(self.webpackChunkultimatehomeserver_com=self.webpackChunkultimatehomeserver_com||[]).push([[127],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>f});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),c=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(r),m=a,f=u["".concat(s,".").concat(m)]||u[m]||d[m]||o;return r?n.createElement(f,i(i({ref:t},p),{},{components:r})):n.createElement(f,i({ref:t},p))}));function f(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<o;c++)i[c]=r[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},1598:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var n=r(7462),a=(r(7294),r(3905));const o={sidebar_position:2},i="Configure SSL",l={unversionedId:"getting-started/ssl",id:"getting-started/ssl",title:"Configure SSL",description:"UHS is configured to allow you to easily add any number of subdomains to your nginx configuration and automatically apply a wildcard certificate to them. Enabling SSL locally is important for security, provides a better experience in the browser, and is especially useful for developers who want to test their applications with SSL enabled.",source:"@site/docs/getting-started/ssl.mdx",sourceDirName:"getting-started",slug:"/getting-started/ssl",permalink:"/docs/getting-started/ssl",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/getting-started/ssl.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Getting Started",permalink:"/docs/getting-started/"},next:{title:"Configure Services",permalink:"/docs/getting-started/configure"}},s={},c=[{value:"Install certbot",id:"install-certbot",level:3},{value:"Configure DNS credentials",id:"configure-dns-credentials",level:3}],p={toc:c},u="wrapper";function d(e){let{components:t,...r}=e;return(0,a.kt)(u,(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"configure-ssl"},"Configure SSL"),(0,a.kt)("p",null,"UHS is configured to allow you to easily add any number of subdomains to your nginx configuration and automatically apply a wildcard certificate to them. Enabling SSL locally is important for security, provides a better experience in the browser, and is especially useful for developers who want to test their applications with SSL enabled."),(0,a.kt)("p",null,"Rather than configuring ingress in our cluster, we opt to use a simpler approach suitable for our home-server using ",(0,a.kt)("a",{parentName:"p",href:"https://certbot.eff.org/"},"certbot")," to create a wildcard cert and ",(0,a.kt)("a",{parentName:"p",href:"https://www.nginx.com/"},"nginx")," as our reverse proxy. We can then mount the certificates as a volume in our cluster."),(0,a.kt)("h3",{id:"install-certbot"},"Install certbot"),(0,a.kt)("p",null,"In this tutorial we will opt for a more manual approach to installing certbot, to avoid running the snap daemon."),(0,a.kt)("p",null,"Follow the official guide on ",(0,a.kt)("a",{parentName:"p",href:"https://certbot.eff.org/instructions?ws=other&os=pip"},"certbot.eff.org")," to install certbot with pip.\nOnce certbot is installed and available at ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/certbot"),", we can create a certificate for our domain."),(0,a.kt)("p",null,"Certbot supports automatic DNS validation with many DNS providers. Install the plugin for your provider."),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"See the list of available ",(0,a.kt)("a",{parentName:"em",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#dns-plugins"},"DNS plugins here."))),(0,a.kt)("p",null,"In this example, we will use ",(0,a.kt)("a",{parentName:"p",href:"https://www.cloudflare.com/dns/"},"Cloudflare")," as our DNS provider. To install the Cloudflare plugin, run:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo /opt/certbot/bin/pip install certbot-dns-cloudflare\n")),(0,a.kt)("h3",{id:"configure-dns-credentials"},"Configure DNS credentials"),(0,a.kt)("p",null,"The documentation above listing the DNS plugins will also provide instructions on how to configure credentials for your DNS provider."),(0,a.kt)("p",null,"If you are using Cloudflare, continue with the following steps."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Create a ",(0,a.kt)("a",{parentName:"li",href:"https://developers.cloudflare.com/fundamentals/api/get-started/create-token/"},"Cloudflare API token")," with the following permissions:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Zone:Zone:Read")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Zone:DNS:Edit")))),(0,a.kt)("li",{parentName:"ol"},"Create a directory to store your credentials. A common practice is to create a directory in your home directory called ",(0,a.kt)("inlineCode",{parentName:"li"},".secrets"),".",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p ~/.secrets/certbot\n"))),(0,a.kt)("li",{parentName:"ol"},"Create a file in this directory called ",(0,a.kt)("inlineCode",{parentName:"li"},"cloudflare.ini")," with the following contents:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"# Cloudflare API token used by Certbot\ndns_cloudflare_api_token = <your token>\n"))),(0,a.kt)("li",{parentName:"ol"},"Set the permissions on this file to ",(0,a.kt)("inlineCode",{parentName:"li"},"600"),":",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 600 ~/.secrets/certbot/cloudflare.ini\n"))),(0,a.kt)("li",{parentName:"ol"},"Run the following command to create a wildcard certificate for your domain:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo /opt/certbot/bin/certbot certonly \\\n    --dns-cloudflare \\\n    --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini \\\n    --dns-cloudflare-propagation-seconds 60 \\\n    -d <your domain>\n    -d *.<your domain>\n")),"Certbot will create a certificate and store it in ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/letsencrypt/live/<your domain>"),". We will use this certificate in our cluster."),(0,a.kt)("li",{parentName:"ol"},"Setup automatic renewal by running the ",(0,a.kt)("inlineCode",{parentName:"li"},"certbot renew")," command in a cron job. Run the following command:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"echo \"0 0,12 * * * root /opt/certbot/bin/python -c 'import random; import time; time.sleep(random.random() * 3600)' && sudo certbot renew -q\" | sudo tee -a /etc/crontab > /dev/null\n")),"Certbot will check the expiration date of your certificate twice a day and renew it if it is within 30 days of expiration."),(0,a.kt)("li",{parentName:"ol"},"Test the renewal process by running:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo /opt/certbot/bin/certbot renew --dry-run\n")),"If the command runs without errors, the renewal process is working correctly."),(0,a.kt)("li",{parentName:"ol"},"Lastly, create a Diffie-Hellman parameters certificate for additional security:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo openssl dhparam -out /etc/letsencrypt/certs/dhparam.pem 2048\n")),"For convenience we will store this certificate in the same directory as our letsencrypt certificates.")))}d.isMDXComponent=!0}}]);